<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning Studio (AI Powered)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #E8E4DE;
            color: #433831;
        }
        
        /* Neumorphism Utilities */
        .shadow-neumorph {
            box-shadow: 9px 9px 18px #cbbdae, -9px -9px 18px #ffffff;
        }
        .shadow-neumorph-sm {
            box-shadow: 5px 5px 10px #cbbdae, -5px -5px 10px #ffffff;
        }
        .shadow-neumorph-hover {
            box-shadow: 12px 12px 24px #cbbdae, -12px -12px 24px #ffffff;
            transform: translateY(-2px);
        }
        .shadow-neumorph-inset {
            box-shadow: inset 6px 6px 12px #cbbdae, inset -6px -6px 12px #ffffff;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ULTIMATE PRINT FIXES --- */
        @media print {
            @page { margin: 1cm; size: A4; }
            
            /* Reset everything */
            html, body {
                background: white !important;
                color: black !important;
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Hide the app UI */
            #root > div > header, 
            #root > div > main > section, 
            .no-print {
                display: none !important;
            }

            /* Force the print area to be the ONLY thing visible and flow naturally */
            #print-area {
                display: block !important;
                position: relative !important; /* Changed from absolute/fixed */
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                color: black !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                left: auto !important;
                top: auto !important;
            }

            /* Ensure text wraps and breaks correctly */
            p, h1, h2, h3, li {
                page-break-inside: auto;
                color: black !important;
            }
            
            /* Specific text styling for print readability */
            .text-accent { color: #000 !important; font-weight: bold !important; text-decoration: none !important; }
            .bg-highlight { border: 1px solid #ccc !important; background-color: #f8f8f8 !important; }
            
            /* Avoid breaking inside vocabulary items */
            .break-inside-avoid {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icons = {
            Coffee: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            Music: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Dice5: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></svg>,
            ChevronDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Feather: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="15"/></svg>,
            Key: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>
        };

        const EnglishMaterialGenerator = () => {
            const [topic, setTopic] = useState('');
            const [difficulty, setDifficulty] = useState('Intermediate');
            const [loading, setLoading] = useState(false);
            const [material, setMaterial] = useState(null);
            const [error, setError] = useState('');
            const [userApiKey, setUserApiKey] = useState('AIzaSyDnY3QgCrJqUNZ8sa8q6U9pMkyBvi2TeL4');
            const [showApiKeyInput, setShowApiKeyInput] = useState(false);

            const saveApiKey = (key) => {
                setUserApiKey(key);
                localStorage.setItem('gemini_api_key', key);
                setShowApiKeyInput(false);
            };
            
            const contentRef = useRef();
        
            const PRESET_TOPICS = [
                "High-End Audio (高級音響)", 
                "Business Negotiation (商務談判)",
                "Daily Conversation (日常會話)",
                "Travel & Culture (旅遊與文化)",
                "Coffee Brewing (手沖咖啡)", 
                "Psychology (心理學)", 
                "Tech Trends (科技趨勢)",
                "Health & Fitness (健康與健身)",
                "Movie Reviews (電影評論)",
                "Investment (投資理財)"
            ];
        
            const RANDOM_TOPICS = [
                "Minimalism Lifestyle", "Jazz History", "Sustainable Living", 
                "Space Exploration", "Wine Tasting", "Digital Marketing", 
                "Ancient Civilizations", "Artificial Intelligence", "Yoga & Meditation",
                "Photography Techniques", "Global Economics", "Interior Design"
            ];
        
            const DIFFICULTY_OPTIONS = [
                { value: "Beginner", label: "初級 (Beginner)", sub: "TOEIC 225-550 | IELTS 3.0-4.0 | A1-A2" },
                { value: "Pre-Intermediate", label: "中初級 (Pre-Intermediate)", sub: "TOEIC 550-650 | IELTS 4.0-5.0 | A2-B1" },
                { value: "Intermediate", label: "中級 (Intermediate)", sub: "TOEIC 650-785 | IELTS 5.0-6.0 | B1" },
                { value: "Upper-Intermediate", label: "中高級 (Upper-Intermediate)", sub: "TOEIC 785-900 | IELTS 6.0-7.0 | B2" },
                { value: "Advanced", label: "高級 (Advanced)", sub: "TOEIC 900-990 | IELTS 7.0-8.0 | C1" }
            ];
        
            const handleRandomTopic = () => {
                const random = RANDOM_TOPICS[Math.floor(Math.random() * RANDOM_TOPICS.length)];
                setTopic(random);
            };
        
            const handlePresetClick = (preset) => {
                setTopic(preset);
            };
        
            const renderFormattedText = (text) => {
                if (!text) return null;
                const parts = text.split(/(<b>.*?<\/b>)/g);
                return parts.map((part, index) => {
                    if (part.startsWith('<b>') && part.endsWith('</b>')) {
                        return <b key={index} className="font-bold text-[#D98E56] text-accent">{part.replace(/<\/?b>/g, '')}</b>;
                    }
                    return <span key={index}>{part}</span>;
                });
            };

            const exportToWord = () => {
                if (!material) return;

                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${material.title}</title>
                <style>
                    body { font-family: 'Times New Roman', serif; }
                    h1 { font-size: 24pt; color: #2C241F; font-weight: bold; }
                    h2 { font-size: 18pt; color: #D98E56; border-bottom: 2px solid #D98E56; padding-bottom: 5px; margin-top: 20px; }
                    h3 { font-size: 14pt; color: #2C241F; font-weight: bold; margin-top: 15px; }
                    p { font-size: 12pt; line-height: 1.5; color: #000000; text-align: justify; }
                    .vocab-item { margin-bottom: 20px; border-left: 3px solid #D98E56; padding-left: 10px; }
                    .highlight { background-color: #FFF8F0; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; }
                    .bold-accent { color: #D98E56; font-weight: bold; }
                    .info-bar { font-size: 10pt; color: #666; margin-bottom: 5px; }
                </style>
                </head><body>`;

                let content = `
                    <h1>${material.title}</h1>
                    <p style="color: #666;">Theme: ${material.theme} | Level: ${material.difficulty}</p>
                    <hr/>
                    
                    <h2>1. Reading Article</h2>
                    ${material.article.split('\n').map(p => `<p>${p.replace(/<b>(.*?)<\/b>/g, '<span class="bold-accent">$1</span>')}</p>`).join('')}
                    
                    <h2>2. Detailed Vocabulary</h2>
                `;

                material.vocabulary.forEach((v, idx) => {
                    content += `
                        <div class="vocab-item">
                            <h3>${idx + 1}. ${v.word} <span style="font-size: 12pt; font-weight: normal; font-style: italic;">(${v.pos})</span> ${v.chinese}</h3>
                            <p class="info-bar">IPA: /${v.ipa}/ | Phonics: ${v.phonics.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')}</p>
                            <p><b>Eng Def:</b> ${v.englishDef}</p>
                            <div class="highlight">
                                <p><b>★ 中文秒懂:</b> ${v.instantUnd}</p>
                            </div>
                            <p><b>● Collocations:</b> ${v.collocations}</p>
                            <p><b>Examples:</b></p>
                            <ul>
                                ${v.sentences.map(s => `<li>${s.en.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')} <br/><span style="color:#666; font-size:10pt;">${s.ch}</span></li>`).join('')}
                            </ul>
                        </div>
                    `;
                });

                if (material.grammar) {
                    content += `<h2>3. Grammar Focus</h2>`;
                    material.grammar.forEach(g => {
                        content += `
                            <div class="highlight">
                                <h3>${g.point}</h3>
                                <p>${g.explanation.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')}</p>
                                <p style="font-style: italic; color: #556943;">"${g.example.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')}"</p>
                            </div>
                        `;
                    });
                }

                const footer = `</body></html>`;
                const sourceHTML = header + content + footer;

                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `${material.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
            };
        
            const generateMaterial = async () => {
                if (!topic) return;
                
                if (!userApiKey) {
                    setShowApiKeyInput(true);
                    return;
                }

                setLoading(true);
                setError('');
                setMaterial(null);
                
                const selectedDiff = DIFFICULTY_OPTIONS.find(d => d.value === difficulty);
                const difficultyDesc = `${selectedDiff.value} level (${selectedDiff.sub})`;
        
                const systemPrompt = `
                    You are an expert English teacher creating high-quality learning materials.
                    
                    **CORE OBJECTIVE:**
                    Generate a comprehensive lesson with a longer article (approx 350-450 words), 15-20 vocabulary words, and a grammar analysis section.
                    
                    **FORMATTING REQUIREMENTS (CRITICAL):**
                    1. **Article Bolding:** In the 'article' text, you MUST wrap the key vocabulary words with \`<b>\` tags ONLY. Do NOT use markdown asterisks (**). Example: "Building a <b>habit</b> is a challenge."
                    2. **Phonics Bolding:** In the 'phonics' field, wrap the STRESSED syllable with \`<b>\` tags. Example: "<b>strug</b>-gle".
                    
                    **VOCABULARY EXPLANATION STYLE:**
                    For "instantUnd" (中文秒懂), explain like you are talking to a junior high student. Use vivid metaphors, analogies, or sensory details.
                    
                    **SENTENCE GENERATION:**
                    Generate **3 to 4 example sentences** for each word.
                    Try to vary the prepositions or context to show different shades of meaning. 
                    
                    **GRAMMAR SECTION:**
                    Include 3-5 key grammar points or sentence structures found in the article. Explain them simply.
                    
                    **JSON OUTPUT SCHEMA:**
                    Return ONLY a valid JSON object:
                    {
                        "title": "Lesson Title",
                        "difficulty": "Difficulty Label",
                        "theme": "Theme Keywords",
                        "article": "Longer article text (4-5 paragraphs) with <b>bold</b> vocabulary words...",
                        "vocabulary": [
                        {
                            "word": "Word",
                            "pos": "v./n./adj.",
                            "chinese": "Chinese Def",
                            "ipa": "IPA",
                            "phonics": "Phonics with <b>stressed</b> syllable",
                            "englishDef": "Simple English Def",
                            "instantUnd": "Metaphorical Chinese explanation",
                            "collocations": "Common usages",
                            "sentences": [
                            { "en": "Sentence 1", "ch": "Translation 1" },
                            { "en": "Sentence 2", "ch": "Translation 2" },
                            { "en": "Sentence 3", "ch": "Translation 3" }
                            ]
                        }
                        ],
                        "grammar": [
                        {
                            "point": "Name of the grammar point",
                            "explanation": "Simple explanation",
                            "example": "Example sentence"
                        }
                        ]
                    }
                    
                    Generate exactly 15 to 20 vocabulary words.
                `;
        
                const userPrompt = `
                    Generate a lesson.
                    Topic: ${topic}
                    Difficulty Level: ${difficultyDesc}
                    Target Audience: Traditional Chinese speakers (Taiwan).
                `;

                // Retry logic wrapper
                const fetchWithRetry = async (retries = 5, delay = 1000) => {
                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: userPrompt }] }],
                                    systemInstruction: { parts: [{ text: systemPrompt }] },
                                    generationConfig: { responseMimeType: "application/json" }
                                }),
                            }
                        );

                        if (response.status === 503 && retries > 0) {
                            console.warn(`Model overloaded (503). Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return fetchWithRetry(retries - 1, delay * 2);
                        }

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error?.message || `API Error: ${response.status}`);
                        }

                        return await response.json();
                    } catch (err) {
                        if (retries > 0 && err.name !== 'Error') {
                             console.warn(`Network error. Retrying in ${delay}ms...`, err);
                             await new Promise(resolve => setTimeout(resolve, delay));
                             return fetchWithRetry(retries - 1, delay * 2);
                        }
                        throw err;
                    }
                };
        
                try {
                    const result = await fetchWithRetry();
                    const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!textResponse) throw new Error("No content generated");
                    setMaterial(JSON.parse(textResponse));
                } catch (err) {
                    console.error(err);
                    setError("生成失敗：" + err.message + "。請稍後再試。");
                } finally {
                    setLoading(false);
                }
            };
        
            const handlePrint = () => {
                window.print();
            };
        
            return (
                <div className="min-h-screen font-sans transition-colors duration-300">
                    
                    {/* Header */}
                    <header className="pt-8 pb-6 px-4 no-print">
                        <div className="max-w-5xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="p-3 rounded-2xl shadow-neumorph-sm bg-[#E8E4DE] text-[#D98E56]">
                                    <Icons.Coffee className="w-6 h-6" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold tracking-wide text-[#433831]">English Studio</h1>
                                    <p className="text-xs text-[#8A7E72] font-medium tracking-wider uppercase">LOBSTER Powered Learning</p>
                                </div>
                            </div>
                            <div className="flex gap-4 items-center">
                                {/* Only show key button if user wants to change the hardcoded one */}
                                <button 
                                    onClick={() => setShowApiKeyInput(!showApiKeyInput)}
                                    className="p-2 rounded-full bg-[#E8E4DE] shadow-neumorph-sm hover:text-[#D98E56] transition-colors"
                                    title="View/Change API Key"
                                >
                                    <Icons.Key className="w-5 h-5" />
                                </button>
                                <div className="w-3 h-3 rounded-full bg-[#D98E56] shadow-[0_0_10px_#D98E56]"></div>
                                <div className="w-3 h-3 rounded-full bg-[#E8E4DE] shadow-neumorph-inset"></div>
                            </div>
                        </div>
                    </header>
        
                    <main className="max-w-5xl mx-auto p-4 md:p-8">

                        {/* API Key Input Section */}
                        {showApiKeyInput && (
                            <div className="mb-8 rounded-3xl p-6 bg-[#E8E4DE] shadow-neumorph-inset no-print border border-[#D98E56]/20">
                                <div className="flex flex-col gap-2">
                                    <label className="text-sm font-bold text-[#6B5D52] uppercase tracking-wider">
                                        Google Gemini API Key
                                    </label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="password" 
                                            value={userApiKey}
                                            onChange={(e) => setUserApiKey(e.target.value)}
                                            placeholder="請輸入您的 Gemini API Key"
                                            className="flex-grow pl-4 pr-4 py-3 bg-[#F2F0EB] rounded-xl text-[#433831] focus:outline-none focus:ring-2 focus:ring-[#D98E56]"
                                        />
                                        <button 
                                            onClick={() => saveApiKey(userApiKey)}
                                            className="px-6 py-2 rounded-xl bg-[#D98E56] text-white font-bold shadow-md hover:bg-[#C27A45] transition-all"
                                        >
                                            Save
                                        </button>
                                    </div>
                                    <p className="text-xs text-[#8A7E72] mt-1">
                                        目前使用預設金鑰。您可以隨時更換為新的金鑰。
                                    </p>
                                </div>
                            </div>
                        )}
                        
                        {/* Controls Panel */}
                        <section className="mb-12 rounded-3xl p-8 bg-[#E8E4DE] shadow-neumorph no-print">
                            <div className="space-y-8">
                                {/* Row 1: Topic Selection */}
                                <div className="space-y-4">
                                    <label className="flex items-center gap-2 text-sm font-bold text-[#6B5D52] uppercase tracking-wider">
                                        <Icons.Music className="w-4 h-4" /> 
                                        1. Topic Selection
                                    </label>
                                    
                                    <div className="flex gap-4">
                                        <div className="relative flex-grow group">
                                            <input 
                                                type="text" 
                                                value={topic}
                                                onChange={(e) => setTopic(e.target.value)}
                                                placeholder="Enter a topic..."
                                                className="w-full pl-6 pr-4 py-4 bg-[#E8E4DE] rounded-2xl shadow-neumorph-inset text-lg text-[#433831] placeholder-[#A89F95] focus:outline-none transition-all"
                                                onKeyDown={(e) => e.key === 'Enter' && generateMaterial()}
                                            />
                                        </div>
                                        <button 
                                            onClick={handleRandomTopic}
                                            className="px-6 rounded-2xl bg-[#E8E4DE] shadow-neumorph hover:shadow-neumorph-hover active:shadow-neumorph-inset text-[#D98E56] transition-all flex items-center justify-center"
                                            title="Random Topic"
                                        >
                                            <Icons.Dice5 className="w-6 h-6" />
                                        </button>
                                    </div>
                
                                    {/* Tags */}
                                    <div className="flex flex-wrap gap-3 mt-2">
                                        {PRESET_TOPICS.map((t) => (
                                            <button
                                                key={t}
                                                onClick={() => handlePresetClick(t)}
                                                className="text-xs font-medium px-4 py-2 rounded-xl bg-[#E8E4DE] text-[#6B5D52] shadow-neumorph-sm hover:text-[#D98E56] active:shadow-neumorph-inset transition-all"
                                            >
                                                {t}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                
                                {/* Row 2: Difficulty & Generate Button */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 pt-2">
                                    {/* Difficulty */}
                                    <div className="space-y-3">
                                        <label className="flex items-center gap-2 text-sm font-bold text-[#6B5D52] uppercase tracking-wider">
                                            <Icons.Settings className="w-4 h-4" /> 
                                            2. Difficulty
                                        </label>
                                        <div className="relative">
                                            <select 
                                                value={difficulty}
                                                onChange={(e) => setDifficulty(e.target.value)}
                                                className="w-full pl-6 pr-10 py-4 bg-[#E8E4DE] rounded-2xl shadow-neumorph appearance-none text-[#433831] font-medium outline-none cursor-pointer hover:shadow-neumorph-hover transition-all text-sm"
                                            >
                                                {DIFFICULTY_OPTIONS.map(opt => (
                                                    <option key={opt.value} value={opt.value}>
                                                        {opt.label} — {opt.sub}
                                                    </option>
                                                ))}
                                            </select>
                                            <Icons.ChevronDown className="absolute right-5 top-1/2 -translate-y-1/2 text-[#D98E56] pointer-events-none w-5 h-5" />
                                        </div>
                                    </div>
                
                                    {/* Generate Button */}
                                    <div className="flex items-end">
                                        <button 
                                            onClick={generateMaterial}
                                            disabled={loading || !topic}
                                            className="w-full py-4 rounded-2xl bg-[#D98E56] text-[#FFF8F0] font-bold text-lg shadow-[6px_6px_12px_#cbbdae,-6px_-6px_12px_#ffffff] hover:bg-[#C27A45] hover:shadow-none active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        >
                                            {loading ? <Icons.Loader2 className="w-6 h-6 animate-spin" /> : <Icons.Sparkles className="w-6 h-6" />}
                                            {loading ? 'Creating...' : 'Generate Lesson'}
                                        </button>
                                    </div>
                                </div>
                            </div>
            
                            {error && (
                                <div className="mt-6 p-4 rounded-xl bg-[#E8E4DE] shadow-neumorph-inset text-[#C2410C] text-sm flex items-center gap-3">
                                    <span className="w-2 h-2 rounded-full bg-[#C2410C] animate-pulse"></span> {error}
                                </div>
                            )}
                        </section>
        
                        {/* Paper / Preview Area */}
                        {material && (
                            <div className="animate-fade-in-up">
                                
                                {/* Toolbar */}
                                <div className="flex justify-end items-center mb-6 px-2 no-print gap-3">
                                    <div className="text-sm text-[#8A7E72] font-medium flex items-center gap-2 mr-auto">
                                        <Icons.Sun className="w-4 h-4" /> Ready to learn
                                    </div>
                                    <button 
                                        onClick={handlePrint}
                                        className="flex items-center gap-2 px-6 py-3 rounded-xl bg-[#E8E4DE] text-[#433831] font-medium shadow-neumorph hover:text-[#D98E56] hover:shadow-neumorph-hover active:shadow-neumorph-inset transition-all"
                                    >
                                        <Icons.Printer className="w-5 h-5" />
                                        Print PDF
                                    </button>
                                    <button 
                                        onClick={exportToWord}
                                        className="flex items-center gap-2 px-6 py-3 rounded-xl bg-[#2b6cb0] text-white font-medium shadow-md hover:bg-[#2c5282] transition-all"
                                    >
                                        <Icons.FileText className="w-5 h-5" />
                                        下載 Word
                                    </button>
                                </div>
                
                                {/* THE PAPER */}
                                <div 
                                    id="print-area"
                                    ref={contentRef}
                                    className="relative bg-[#F9F7F5] text-black shadow-[0_20px_40px_-15px_rgba(67,56,49,0.2)] p-10 md:p-[3cm] min-h-[29.7cm] mx-auto w-full max-w-[21cm]"
                                    style={{ fontFamily: '"Noto Serif TC", "Times New Roman", serif' }}
                                >
                                    
                                    {/* Decorative Header Line for Paper */}
                                    <div className="w-full h-2 bg-[#D98E56] mb-10 print:bg-black"></div>
                
                                    {/* Document Title */}
                                    <div className="pb-8 mb-8 border-b border-dashed border-gray-300">
                                        <h1 className="text-4xl font-bold text-[#2C241F] mb-4 leading-tight">{material.title}</h1>
                                        <div className="flex flex-wrap items-center gap-6 text-sm text-[#6B5D52] font-sans">
                                            <span className="flex items-center gap-2 uppercase tracking-widest font-bold">
                                                {DIFFICULTY_OPTIONS.find(d => d.value === material.difficulty)?.label || material.difficulty}
                                            </span>
                                            <span className="w-1.5 h-1.5 rounded-full bg-[#D98E56]"></span>
                                            <span className="italic">
                                                Theme: {material.theme}
                                            </span>
                                        </div>
                                    </div>
                
                                    {/* Section 1: Article */}
                                    <section className="mb-14">
                                        <h2 className="text-2xl font-bold text-[#2C241F] mb-6 flex items-center gap-3 font-sans">
                                            <span className="text-[#D98E56] text-3xl print:text-black">01.</span> Reading Article
                                        </h2>
                                        <div className="text-[1.05rem] leading-[1.9] text-[#433831] space-y-5 text-justify font-serif">
                                            {material.article.split('\n').map((para, idx) => (
                                                <p key={idx}>
                                                    {renderFormattedText(para)}
                                                </p>
                                            ))}
                                        </div>
                                    </section>
                
                                    {/* Section 2: Vocabulary */}
                                    <section className="break-before-auto">
                                        <h2 className="text-2xl font-bold text-[#2C241F] mb-8 flex items-center gap-3 font-sans border-t border-gray-200 pt-8">
                                            <span className="text-[#D98E56] text-3xl print:text-black">02.</span> Detailed Vocabulary
                                        </h2>
                                        
                                        <div className="space-y-10">
                                            {material.vocabulary.map((vocab, index) => (
                                                <div key={index} className="break-inside-avoid relative pl-4 border-l-2 border-[#E8E4DE] hover:border-[#D98E56] transition-colors duration-300">
                                                    
                                                    {/* Word Header */}
                                                    <div className="flex flex-wrap items-baseline gap-x-4 mb-3">
                                                        <span className="text-sm font-bold text-[#A89F95] font-sans">#{index + 1}</span>
                                                        <h3 className="text-3xl font-bold text-[#2C241F] font-sans tracking-tight">{vocab.word}</h3>
                                                        <span className="text-lg text-[#8A7E72] font-serif italic">{vocab.pos}</span>
                                                        <span className="text-xl font-medium text-[#433831]">{vocab.chinese}</span>
                                                    </div>
                            
                                                    {/* Info Bar */}
                                                    <div className="flex flex-wrap items-center gap-4 text-sm text-[#6B5D52] font-sans mb-4 bg-[#F2F0EB] p-2 rounded-lg bg-highlight">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-[#D98E56] font-bold text-accent">IPA</span> 
                                                            <span className="font-mono">/{vocab.ipa}/</span>
                                                        </div>
                                                        <div className="w-1 h-1 bg-[#A89F95] rounded-full"></div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-[#D98E56] font-bold text-accent">Phonics</span>
                                                            <span className="font-mono tracking-wide">{renderFormattedText(vocab.phonics)}</span>
                                                        </div>
                                                    </div>
                            
                                                    {/* Definitions Grid */}
                                                    <div className="grid grid-cols-1 gap-4 mb-4">
                                                        
                                                        {/* Instant Understanding */}
                                                        <div className="bg-[#FFF8F0] p-4 rounded-xl border-l-4 border-[#D98E56] bg-highlight">
                                                            <div className="font-bold text-[#D98E56] text-xs mb-1 font-sans uppercase tracking-wider flex items-center gap-2 text-accent">
                                                                <Icons.Sparkles className="w-3 h-3" /> Instant Understanding (中文秒懂)
                                                            </div>
                                                            <p className="text-[#433831] leading-relaxed text-sm md:text-base font-medium">
                                                                {vocab.instantUnd}
                                                            </p>
                                                        </div>
                            
                                                        {/* English Def */}
                                                        <div className="text-[#433831] leading-snug pl-1">
                                                            <span className="font-bold text-[#2C241F] mr-2 text-sm uppercase">Eng Def:</span>
                                                            {vocab.englishDef}
                                                        </div>
                                                    </div>
                            
                                                    {/* Sentences & Collocations */}
                                                    <div className="pl-1 mt-2 space-y-3">
                                                        <div className="text-sm text-[#6B5D52]">
                                                            <span className="font-bold text-[#2C241F] mr-2">Collocations:</span>
                                                            <span className="italic border-b border-[#E8E4DE] pb-0.5">{vocab.collocations}</span>
                                                        </div>
                                                        
                                                        <div className="space-y-2 mt-2">
                                                            {vocab.sentences.map((sent, sIdx) => (
                                                                <div key={sIdx} className="text-[#433831] text-sm leading-relaxed flex gap-2">
                                                                    <span className="text-[#D98E56] font-bold text-xs mt-1 text-accent">0{sIdx + 1}</span>
                                                                    <div>
                                                                        <div>{renderFormattedText(sent.en)}</div>
                                                                        <div className="text-[#8A7E72] text-xs mt-0.5">{sent.ch}</div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </section>
                                    
                                    {/* Section 3: Grammar */}
                                    {material.grammar && (
                                        <section className="break-before-auto mt-12">
                                            <h2 className="text-2xl font-bold text-[#2C241F] mb-6 flex items-center gap-3 font-sans border-t border-gray-200 pt-8">
                                                <span className="text-[#65A30D] text-3xl print:text-black">03.</span> Grammar Focus
                                            </h2>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 print:grid-cols-1">
                                                {material.grammar.map((item, idx) => (
                                                    <div key={idx} className="bg-[#F5F9F0] p-6 rounded-2xl border border-[#E2E8D8] break-inside-avoid bg-highlight">
                                                        <div className="flex items-center gap-2 mb-3">
                                                            <Icons.Feather className="w-5 h-5 text-[#65A30D] text-accent" />
                                                            <h3 className="font-bold text-lg text-[#365314] text-accent">{item.point}</h3>
                                                        </div>
                                                        <p className="text-[#433831] mb-4 text-sm leading-relaxed min-h-[3em]">{renderFormattedText(item.explanation)}</p>
                                                        <div className="bg-white/80 p-3 rounded-lg border border-[#E2E8D8] text-[#556943] text-sm font-serif italic print:border-gray-200">
                                                            "{renderFormattedText(item.example)}"
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </section>
                                    )}
                
                                    <footer className="mt-16 flex justify-between items-center text-[#A89F95] text-[10px] font-sans border-t border-gray-200 pt-6 uppercase tracking-widest">
                                        <span>Created for Audiophile & Learner</span>
                                        <span>{new Date().toLocaleDateString()}</span>
                                    </footer>
                                </div>
                            </div>
                        )}
        
                        {/* Empty State */}
                        {!material && !loading && (
                            <div className="text-center py-32 text-[#A89F95] no-print select-none animate-pulse-slow">
                                <div className="w-24 h-24 rounded-full bg-[#E8E4DE] shadow-neumorph mx-auto mb-8 flex items-center justify-center text-[#D98E56]">
                                    <Icons.Coffee className="w-10 h-10" />
                                </div>
                                <p className="text-2xl font-bold text-[#6B5D52] mb-2">Design Your Learning</p>
                                <p className="text-sm text-[#8A7E72]">Select a topic above to begin your session</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnglishMaterialGenerator />);
    </script>
</body>
</html>
