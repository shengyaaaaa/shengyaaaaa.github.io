<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOBSTER English Learning Studio</title>
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- DYNAMIC THEME VARIABLES --- */
        :root {
            --bg-body: #E8E4DE;
            --bg-panel: #E8E4DE;
            --bg-paper: #F9F7F5;
            --text-main: #433831;
            --text-muted: #8A7E72;
            --accent: #D98E56;
            --accent-hover: #C27A45;
            --shadow-light: #ffffff;
            --shadow-dark: #cbbdae;
            --highlight-bg: #FFF8F0;
            --highlight-border: #D98E56;
        }

        [data-theme='dark'] {
            --bg-body: #1a1a1a;
            --bg-panel: #262626;
            --bg-paper: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #ff9d5c;
            --accent-hover: #ffb07c;
            --shadow-light: #333333;
            --shadow-dark: #151515;
            --highlight-bg: #2d2a26;
            --highlight-border: #ff9d5c;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        /* Neumorphism Utilities */
        .shadow-neumorph {
            box-shadow: 9px 9px 18px var(--shadow-dark), -9px -9px 18px var(--shadow-light);
            background-color: var(--bg-panel);
        }
        .shadow-neumorph-sm {
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            background-color: var(--bg-panel);
        }
        .shadow-neumorph-hover {
            box-shadow: 12px 12px 24px var(--shadow-dark), -12px -12px 24px var(--shadow-light);
            transform: translateY(-2px);
        }
        .shadow-neumorph-inset {
            box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);
            background-color: var(--bg-panel);
        }

        .paper-shadow {
            box-shadow: 0 20px 40px -15px rgba(0,0,0,0.2);
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- PRINT FIXES --- */
        @media print {
            @page { margin: 1cm; size: A4; }
            html, body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; background: white !important; height: auto !important; overflow: visible !important; margin: 0 !important; padding: 0 !important; }
            #root > div > header, #root > div > main > section, .no-print { display: none !important; }
            #print-area { display: block !important; position: relative !important; width: 100% !important; height: auto !important; overflow: visible !important; background-color: #ffffff !important; color: #433831 !important; box-shadow: none !important; margin: 0 !important; padding: 0 !important; left: auto !important; top: auto !important; }
            p, h1, h3, li, span, div { color: inherit !important; text-shadow: none !important; }
            h1 { color: #2C241F !important; }
            h2 { color: #433831 !important; border-bottom: 2px solid #E8E4DE !important; }
            .text-accent { color: #D98E56 !important; font-weight: bold !important; }
            .bg-highlight { background-color: #FFF8F0 !important; border-left: 4px solid #D98E56 !important; border: 1px solid #eee !important; }
            .speaker-icon { display: none !important; }
            .break-inside-avoid { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icons = {
            Coffee: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            Music: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Dice5: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></svg>,
            ChevronDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Volume2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            Feather: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="15"/></svg>,
            Key: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
            PenTool: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
        };

        const EnglishMaterialGenerator = () => {
            const [topic, setTopic] = useState('');
            const [difficulty, setDifficulty] = useState('Intermediate');
            const [style, setStyle] = useState('Magazine');
            const [loading, setLoading] = useState(false);
            const [material, setMaterial] = useState(null);
            const [error, setError] = useState('');
            const [userApiKey, setUserApiKey] = useState('');
            const [showApiKeyInput, setShowApiKeyInput] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);

            // --- Effects ---
            useEffect(() => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) setUserApiKey(storedKey);
                else setShowApiKeyInput(true);

                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    setIsDarkMode(true);
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            }, []);

            const toggleTheme = () => {
                const newMode = !isDarkMode;
                setIsDarkMode(newMode);
                document.documentElement.setAttribute('data-theme', newMode ? 'dark' : 'light');
                localStorage.setItem('theme', newMode ? 'dark' : 'light');
            };

            const saveApiKey = (key) => {
                setUserApiKey(key);
                localStorage.setItem('gemini_api_key', key);
                setShowApiKeyInput(false);
            };
            
            const contentRef = useRef();
        
            // --- Speech ---
            const speakText = (text) => {
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                    setIsSpeaking(false);
                    return;
                }
                const plainText = text.replace(/<[^>]*>/g, '').replace(/\*\*(.*?)\*\*/g, '$1'); 
                const utterance = new SpeechSynthesisUtterance(plainText);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.lang === 'en-US');
                if (preferredVoice) utterance.voice = preferredVoice;

                utterance.onstart = () => setIsSpeaking(true);
                utterance.onend = () => setIsSpeaking(false);
                utterance.onerror = () => setIsSpeaking(false);
                window.speechSynthesis.speak(utterance);
            };

            // --- Markdown ---
            const copyMarkdown = () => {
                if (!material) return;
                let md = `# ${material.title}\n\n**Theme:** ${material.theme} | **Level:** ${material.difficulty} | **Style:** ${style}\n\n## 1. Reading Article\n\n${material.article.replace(/<b>(.*?)<\/b>/g, '**$1**')}\n\n## 2. Detailed Vocabulary\n\n`;
                material.vocabulary.forEach((v, idx) => {
                    md += `### ${idx + 1}. ${v.word} (${v.pos}) ${v.chinese}\n- **IPA:** /${v.ipa}/ | **Phonics:** ${v.phonics.replace(/<b>(.*?)<\/b>/g, '**$1**')}\n- **Definition:** ${v.englishDef}\n- **中文秒懂:** ${v.instantUnd}\n- **Collocations:** ${v.collocations}\n- **Examples:**\n`;
                    v.sentences.forEach(s => md += `  - ${s.en.replace(/<b>(.*?)<\/b>/g, '**$1**')} (${s.ch})\n`);
                    md += `\n`;
                });
                if (material.grammar) {
                    md += `## 3. Grammar Focus\n\n`;
                    material.grammar.forEach(g => md += `### ${g.point}\n${g.explanation.replace(/<b>(.*?)<\/b>/g, '**$1**')}\n\n> *${g.example.replace(/<b>(.*?)<\/b>/g, '**$1**')}*\n\n`);
                }
                navigator.clipboard.writeText(md).then(() => alert('Markdown copied!'));
            };

            // --- Word ---
            const exportToWord = () => {
                if (!material) return;
                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${material.title}</title><style>body { font-family: 'Times New Roman', serif; } h1 { font-size: 24pt; color: #2C241F; font-weight: bold; } h2 { font-size: 18pt; color: #D98E56; border-bottom: 2px solid #D98E56; padding-bottom: 5px; margin-top: 20px; } h3 { font-size: 14pt; color: #2C241F; font-weight: bold; margin-top: 15px; } p { font-size: 12pt; line-height: 1.5; color: #000000; text-align: justify; } .vocab-item { margin-bottom: 20px; border-left: 3px solid #D98E56; padding-left: 10px; } .highlight { background-color: #FFF8F0; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; } .bold-accent { color: #D98E56; font-weight: bold; } .info-bar { font-size: 10pt; color: #666; margin-bottom: 5px; }</style></head><body>`;
                let content = `<h1>${material.title}</h1><p style="color: #666;">Theme: ${material.theme} | Level: ${material.difficulty} | Style: ${style}</p><hr/><h2>1. Reading Article</h2>${material.article.split('\n').map(p => `<p>${p.replace(/<b>(.*?)<\/b>/g, '<span class="bold-accent">$1</span>')}</p>`).join('')}<h2>2. Detailed Vocabulary</h2>`;
                material.vocabulary.forEach((v, idx) => {
                    content += `<div class="vocab-item"><h3>${idx + 1}. ${v.word} <span style="font-size: 12pt; font-weight: normal; font-style: italic;">(${v.pos})</span> ${v.chinese}</h3><p class="info-bar">IPA: /${v.ipa}/ | Phonics: ${v.phonics.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')}</p><p><b>Eng Def:</b> ${v.englishDef}</p><div class="highlight"><p><b>★ 中文秒懂:</b> ${v.instantUnd}</p></div><p><b>● Collocations:</b> ${v.collocations}</p><p><b>Examples:</b></p><ul>${v.sentences.map(s => `<li>${s.en.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')} <br/><span style="color:#666; font-size:10pt;">${s.ch}</span></li>`).join('')}</ul></div>`;
                });
                if (material.grammar) {
                    content += `<h2>3. Grammar Focus</h2>`;
                    material.grammar.forEach(g => content += `<div class="highlight"><h3>${g.point}</h3><p>${g.explanation.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')}</p><p style="font-style: italic; color: #556943;">"${g.example.replace(/<b>(.*?)<\/b>/g, '<b>$1</b>')}"</p></div>`);
                }
                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + content + '</body></html>');
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `${material.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
            };

            // --- Data ---
            const PRESET_TOPICS = ["High-End Audio (高級音響)", "Business Negotiation (商務談判)", "Daily Conversation (日常會話)", "Travel & Culture (旅遊與文化)", "Coffee Brewing (手沖咖啡)", "Psychology (心理學)", "Tech Trends (科技趨勢)", "Health & Fitness (健康與健身)", "Movie Reviews (電影評論)", "Investment (投資理財)"];
            const RANDOM_TOPICS = ["Minimalism", "Jazz History", "Sustainability", "Space", "Wine", "Digital Marketing", "History", "AI", "Yoga", "Photography", "Economics", "Design"];
            
            // Restoring detailed level descriptions
            const DIFFICULTY_OPTIONS = [
                { value: "Novice", label: "新手 (Novice)", sub: "TOEIC 0-200 | A1" },
                { value: "Beginner", label: "初級 (Beginner)", sub: "TOEIC 200-350 | A2" },
                { value: "High Beginner", label: "中初級 (High Beginner)", sub: "TOEIC 350-550 | A2+" },
                { value: "Pre-Intermediate", label: "中級預備 (Pre-Intermediate)", sub: "TOEIC 550-700 | B1" },
                { value: "Intermediate", label: "中級 (Intermediate)", sub: "TOEIC 700-850 | B1+" },
                { value: "Upper-Intermediate", label: "中高級 (Upper-Intermediate)", sub: "TOEIC 850-945 | B2" },
                { value: "Advanced", label: "高級 (Advanced)", sub: "TOEIC 945+ | C1" }
            ];

            const STYLE_OPTIONS = [
                { value: "Magazine", label: "Lifestyle Magazine (Bon Appétit / Kinfolk)", desc: "Elegant, sensory, engaging, warm tone." },
                { value: "Tech", label: "Tech & Future (Wired / The Verge)", desc: "Crisp, analytical, forward-looking, precise." },
                { value: "Literary", label: "Literary (The New Yorker)", desc: "Sophisticated, narrative-driven, complex structures." },
                { value: "Academic", label: "Academic (TOEIC / IELTS / Science)", desc: "Formal, objective, structured, vocabulary-rich." },
                { value: "Casual", label: "Casual (Blog / Podcast)", desc: "Conversational, friendly, idiomatic, relaxed." }
            ];
        
            const handleRandomTopic = () => setTopic(RANDOM_TOPICS[Math.floor(Math.random() * RANDOM_TOPICS.length)]);
            const handlePresetClick = (preset) => setTopic(preset);
            
            const renderFormattedText = (text) => {
                if (!text) return null;
                // Handle BOTH <b> and ** formats for display
                const parts = text.split(/(<b>.*?<\/b>|\*\*.*?\*\*)/g);
                return parts.map((part, index) => {
                    if (part.startsWith('<b>') && part.endsWith('</b>')) {
                        return <b key={index} className="text-accent">{part.replace(/<\/?b>/g, '')}</b>;
                    }
                    if (part.startsWith('**') && part.endsWith('**')) {
                        return <b key={index} className="text-accent">{part.replace(/\*\*/g, '')}</b>;
                    }
                    return <span key={index}>{part}</span>;
                });
            };
        
            const generateMaterial = async () => {
                if (!topic) return;
                if (!userApiKey) { setShowApiKeyInput(true); return; }
                setLoading(true); setError(''); setMaterial(null);
                
                const selectedDiff = DIFFICULTY_OPTIONS.find(d => d.value === difficulty);
                const selectedStyle = STYLE_OPTIONS.find(s => s.value === style);

                // --- VARIETY GENERATOR ---
                // Randomly select a "lens" or "focus" to avoid repetitive content for the same topic.
                const angles = [
                    "historical evolution", "future trends and predictions", "psychological and emotional impact",
                    "scientific mechanism/breakdown", "economic and business perspective", "cultural significance",
                    "common myths vs. facts", "a day in the life / narrative approach", "ethical or philosophical debate",
                    "practical 'how-to' guide", "expert opinion and analysis", "beginner's journey"
                ];
                const randomAngle = angles[Math.floor(Math.random() * angles.length)];
                
                // --- PROMPT ENGINEERING BASED ON STYLE ---
                let styleInstruction = "";
                if (style === "Magazine") {
                    styleInstruction = "Write like a senior editor for Bon Appétit or Kinfolk. Use sensory details, elegant phrasing, and a warm, inviting tone. Focus on lifestyle, aesthetics, and human connection.";
                } else if (style === "Tech") {
                    styleInstruction = "Write like a tech journalist for Wired or The Verge. Be crisp, analytical, and forward-looking. Use precise terminology but explain it clearly. Focus on innovation and impact.";
                } else if (style === "Literary") {
                    styleInstruction = "Write like a contributor to The New Yorker or The Atlantic. Use sophisticated vocabulary, varied sentence structures (long/short mix), and a narrative, storytelling approach.";
                } else if (style === "Academic") {
                    styleInstruction = "Write a formal, structured passage suitable for TOEIC Part 7 or IELTS Reading. Maintain objectivity, use transition words (However, Therefore), and focus on logic and facts.";
                } else if (style === "Casual") {
                    styleInstruction = "Write like a popular blogger or podcaster. Be friendly, conversational, and use idioms. It's okay to use contractions (don't, can't) and address the reader directly ('You might wonder...').";
                }

                const systemPrompt = `
                    You are an expert native English writer.
                    **TASK:** Create a lesson on '${topic}'.
                    
                    **CRITICAL: VARIETY & ANGLE**
                    To avoid generic content, please write this specific article focusing on the **${randomAngle}** of the topic.
                    
                    **STYLE & TONE:** ${styleInstruction}
                    **LEVEL:** ${selectedDiff.value} (${selectedDiff.sub}). Adjust vocabulary and grammar complexity accordingly.

                    **CRITICAL RULES:**
                    1. **Natural:** Must sound HUMAN and NATIVE. No robotic phrasing.
                    2. **Variety:** Mix sentence lengths. Create rhythm.
                    3. **Vocabulary:** Let words emerge naturally. Do not force them.
                    4. **Structure:** 4-5 paragraphs.
                    
                    **FORMAT:**
                    - Bold 15-20 key words in the article using \`<b>\`. **CRITICAL: EVERY BOLD WORD MUST BE IN THE VOCABULARY LIST.**
                    - **Instant Understanding (中文秒懂):** **CRITICAL: MUST BE IN TRADITIONAL CHINESE (繁體中文).** Explain definitions using metaphors/analogies for a junior high student. Do NOT use English here.
                    - **JSON Output Only.**
                    
                    **JSON SCHEMA:**
                    {
                        "title": "Title",
                        "difficulty": "Level",
                        "theme": "Keywords",
                        "article": "Text with <b>bold</b> words...",
                        "vocabulary": [
                            { "word": "Word", "pos": "n./v.", "chinese": "Def", "ipa": "IPA", "phonics": "pho-<b>nics</b>", "englishDef": "Def", "instantUnd": "Metaphor (in Traditional Chinese)", "collocations": "Usage", "sentences": [{ "en": "Ex 1", "ch": "Trans 1" }, { "en": "Ex 2", "ch": "Trans 2" }, { "en": "Ex 3", "ch": "Trans 3" }] }
                        ],
                        "grammar": [
                            { "point": "Point", "explanation": "Exp", "example": "Ex" }
                        ]
                    }
                `;
        
                // Improved Retry Logic with higher temperature for variety
                const fetchWithRetry = async (retries = 3, delay = 2000) => {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: "Generate the lesson JSON." }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { 
                                    responseMimeType: "application/json",
                                    temperature: 1.1 // Higher temperature for more creative/varied output
                                }
                            })
                        });

                        if ((response.status === 503 || response.status === 429) && retries > 0) {
                            console.warn(`Model busy (${response.status}). Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return fetchWithRetry(retries - 1, delay * 2);
                        }

                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({}));
                            throw new Error(errData.error?.message || `API Error: ${response.status}`);
                        }
                        
                        return await response.json();
                    } catch (err) {
                        if (retries > 0 && err.name !== 'Error') {
                             console.warn(`Network error. Retrying in ${delay}ms...`, err);
                             await new Promise(resolve => setTimeout(resolve, delay));
                             return fetchWithRetry(retries - 1, delay * 2);
                        }
                        throw err;
                    }
                };

                try {
                    const result = await fetchWithRetry();
                    const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!textResponse) throw new Error("No content generated");
                    setMaterial(JSON.parse(textResponse));
                } catch (err) {
                    console.error(err);
                    setError("生成失敗，請稍後再試。");
                } finally {
                    setLoading(false);
                }
            };
        
            const handlePrint = () => window.print();
        
            return (
                <div className="min-h-screen font-sans transition-colors duration-300">
                    <header className="pt-8 pb-6 px-4 no-print flex items-center justify-between max-w-5xl mx-auto">
                        <div className="flex items-center gap-3">
                            <div className="p-3 rounded-2xl shadow-neumorph-sm text-[var(--accent)]"><Icons.Coffee className="w-6 h-6" /></div>
                            <div><h1 className="text-2xl font-bold tracking-wide">LOBSTER English Studio</h1><p className="text-xs opacity-60 font-medium tracking-wider uppercase">GAY BLESS YOU!</p></div>
                        </div>
                        <div className="flex gap-4 items-center">
                            <button onClick={toggleTheme} className="p-2 rounded-full bg-[var(--bg-panel)] shadow-neumorph-sm hover:text-[var(--accent)] transition-colors">{isDarkMode ? <Icons.Sun className="w-5 h-5" /> : <Icons.Moon className="w-5 h-5" />}</button>
                            <button onClick={() => setShowApiKeyInput(!showApiKeyInput)} className="p-2 rounded-full bg-[var(--bg-panel)] shadow-neumorph-sm hover:text-[var(--accent)] transition-colors"><Icons.Key className="w-5 h-5" /></button>
                            <div className="w-3 h-3 rounded-full bg-[var(--accent)] shadow-[0_0_10px_var(--accent)]"></div>
                        </div>
                    </header>
                    <main className="max-w-5xl mx-auto p-4 md:p-8">
                        {showApiKeyInput && (
                            <div className="mb-8 rounded-3xl p-6 bg-[var(--bg-panel)] shadow-neumorph-inset no-print border border-[var(--accent)]/20">
                                <div className="flex gap-2"><input type="password" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} placeholder="Enter Gemini API Key" className="flex-grow pl-4 pr-4 py-3 bg-[var(--bg-body)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" /><button onClick={() => saveApiKey(userApiKey)} className="px-6 py-2 rounded-xl bg-[var(--accent)] text-[var(--bg-body)] font-bold shadow-md hover:opacity-90">Save</button></div>
                            </div>
                        )}
                        <section className="mb-12 rounded-3xl p-8 bg-[var(--bg-panel)] shadow-neumorph no-print">
                            <div className="space-y-8">
                                <div className="space-y-4">
                                    <label className="flex items-center gap-2 text-sm font-bold uppercase tracking-wider opacity-70"><Icons.Music className="w-4 h-4" /> 1. Topic</label>
                                    <div className="flex gap-4">
                                        <div className="relative flex-grow group"><input type="text" value={topic} onChange={(e) => setTopic(e.target.value)} placeholder="Enter topic..." className="w-full pl-6 pr-4 py-4 bg-[var(--bg-panel)] rounded-2xl shadow-neumorph-inset text-lg placeholder-opacity-50 focus:outline-none transition-all" style={{ color: 'var(--text-main)' }} onKeyDown={(e) => e.key === 'Enter' && generateMaterial()} /></div>
                                        <button onClick={handleRandomTopic} className="px-6 rounded-2xl bg-[var(--bg-panel)] shadow-neumorph hover:shadow-neumorph-hover active:shadow-neumorph-inset text-[var(--accent)]"><Icons.Dice5 className="w-6 h-6" /></button>
                                    </div>
                                    <div className="flex flex-wrap gap-3 mt-2">{PRESET_TOPICS.map((t) => <button key={t} onClick={() => handlePresetClick(t)} className="text-xs font-medium px-4 py-2 rounded-xl bg-[var(--bg-panel)] opacity-80 shadow-neumorph-sm hover:text-[var(--accent)] hover:opacity-100 active:shadow-neumorph-inset transition-all">{t}</button>)}</div>
                                </div>
                                
                                <div className="grid grid-cols-1 gap-6 pt-2">
                                    {/* Level Selection Row */}
                                    <div className="space-y-3">
                                        <label className="flex items-center gap-2 text-sm font-bold uppercase tracking-wider opacity-70"><Icons.Settings className="w-4 h-4" /> 2. Level</label>
                                        <div className="relative"><select value={difficulty} onChange={(e) => setDifficulty(e.target.value)} className="w-full pl-6 pr-10 py-4 bg-[var(--bg-panel)] rounded-2xl shadow-neumorph appearance-none font-medium outline-none cursor-pointer hover:shadow-neumorph-hover transition-all text-sm" style={{ color: 'var(--text-main)' }}>{DIFFICULTY_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label} — {opt.sub}</option>)}</select><Icons.ChevronDown className="absolute right-5 top-1/2 -translate-y-1/2 text-[var(--accent)] pointer-events-none w-5 h-5" /></div>
                                    </div>

                                    {/* Style & Generate Button Row */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-3">
                                            <label className="flex items-center gap-2 text-sm font-bold uppercase tracking-wider opacity-70"><Icons.PenTool className="w-4 h-4" /> 3. Style</label>
                                            <div className="relative"><select value={style} onChange={(e) => setStyle(e.target.value)} className="w-full pl-6 pr-10 py-4 bg-[var(--bg-panel)] rounded-2xl shadow-neumorph appearance-none font-medium outline-none cursor-pointer hover:shadow-neumorph-hover transition-all text-sm" style={{ color: 'var(--text-main)' }}>{STYLE_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select><Icons.ChevronDown className="absolute right-5 top-1/2 -translate-y-1/2 text-[var(--accent)] pointer-events-none w-5 h-5" /></div>
                                        </div>
                                        <div className="flex items-end"><button onClick={generateMaterial} disabled={loading || !topic} className="w-full py-4 rounded-2xl bg-[var(--accent)] text-[var(--bg-body)] font-bold text-lg shadow-[6px_6px_12px_var(--shadow-dark),-6px_-6px_12px_var(--shadow-light)] hover:opacity-90 hover:shadow-none active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">{loading ? <Icons.Loader2 className="w-6 h-6 animate-spin" /> : <Icons.Sparkles className="w-6 h-6" />} {loading ? 'Creating...' : 'Generate'}</button></div>
                                    </div>
                                </div>
                            </div>
                            {error && <div className="mt-6 p-4 rounded-xl bg-[var(--bg-panel)] shadow-neumorph-inset text-red-500 text-sm flex items-center gap-3"><span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> {error}</div>}
                        </section>
                        {material && (
                            <div className="animate-fade-in-up">
                                <div className="flex justify-end items-center mb-6 px-2 no-print gap-3 flex-wrap">
                                    <div className="text-sm opacity-60 font-medium flex items-center gap-2 mr-auto"><Icons.Sun className="w-4 h-4" /> Ready to learn</div>
                                    <button onClick={copyMarkdown} className="flex items-center gap-2 px-4 py-2 rounded-xl bg-[var(--bg-panel)] opacity-80 font-medium shadow-neumorph hover:text-[var(--accent)] hover:opacity-100 hover:shadow-neumorph-hover active:shadow-neumorph-inset transition-all text-sm" title="Copy Markdown"><Icons.Copy className="w-4 h-4" /> Markdown</button>
                                    <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 rounded-xl bg-[var(--bg-panel)] opacity-80 font-medium shadow-neumorph hover:text-[var(--accent)] hover:opacity-100 hover:shadow-neumorph-hover active:shadow-neumorph-inset transition-all text-sm"><Icons.Printer className="w-4 h-4" /> Print PDF</button>
                                    <button onClick={exportToWord} className="flex items-center gap-2 px-4 py-2 rounded-xl bg-[#2b6cb0] text-white font-medium shadow-md hover:bg-[#2c5282] transition-all text-sm"><Icons.FileText className="w-4 h-4" /> Word</button>
                                </div>
                                <div id="print-area" ref={contentRef} className="relative p-10 md:p-[3cm] min-h-[29.7cm] mx-auto w-full max-w-[21cm] paper-shadow" style={{ fontFamily: '"Noto Serif TC", "Times New Roman", serif', backgroundColor: 'var(--bg-paper)', color: 'var(--text-main)' }}>
                                    <div className="w-full h-2 bg-[var(--accent)] mb-10 print:bg-black"></div>
                                    <div className="pb-8 mb-8 border-b border-dashed border-gray-300">
                                        <h1 className="text-4xl font-bold mb-4 leading-tight" style={{ color: 'var(--text-main)' }}>{material.title}</h1>
                                        <div className="flex flex-wrap items-center gap-6 text-sm font-sans opacity-70">
                                            <span className="flex items-center gap-2 uppercase tracking-widest font-bold">{DIFFICULTY_OPTIONS.find(d => d.value === material.difficulty)?.label || material.difficulty}</span>
                                            <span className="w-1.5 h-1.5 rounded-full bg-[var(--accent)]"></span>
                                            <span className="italic">Style: {STYLE_OPTIONS.find(s => s.value === style)?.label}</span>
                                        </div>
                                    </div>
                                    <section className="mb-14">
                                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-3 font-sans" style={{ color: 'var(--text-main)' }}><span className="text-[var(--accent)] text-3xl print:text-black">01.</span> Reading Article</h2>
                                        <div className="text-[1.05rem] leading-[1.9] space-y-5 text-justify font-serif" style={{ color: 'var(--text-main)' }}>{material.article.split('\n').map((para, idx) => <p key={idx}>{renderFormattedText(para)}</p>)}</div>
                                    </section>
                                    <section className="break-before-auto">
                                        <h2 className="text-2xl font-bold mb-8 flex items-center gap-3 font-sans border-t border-gray-200 pt-8" style={{ color: 'var(--text-main)' }}><span className="text-[var(--accent)] text-3xl print:text-black">02.</span> Detailed Vocabulary</h2>
                                        <div className="space-y-10">{material.vocabulary.map((vocab, index) => (
                                            <div key={index} className="break-inside-avoid relative pl-4 border-l-2 hover:border-[var(--accent)] transition-colors duration-300" style={{ borderColor: 'var(--bg-panel)' }}>
                                                <div className="flex flex-wrap items-baseline gap-x-4 mb-3">
                                                    <span className="text-sm font-bold opacity-50 font-sans">#{index + 1}</span>
                                                    <h3 className="text-3xl font-bold font-sans tracking-tight" style={{ color: 'var(--text-main)' }}>{vocab.word}<button onClick={() => speakText(vocab.word)} className="ml-3 inline-flex align-middle p-1.5 rounded-full bg-[var(--bg-panel)] text-[var(--accent)] hover:scale-110 transition-transform speaker-icon no-print" title="Listen"><Icons.Volume2 className="w-4 h-4" /></button></h3>
                                                    <span className="text-lg opacity-60 font-serif italic">{vocab.pos}</span>
                                                    <span className="text-xl font-medium" style={{ color: 'var(--text-main)' }}>{vocab.chinese}</span>
                                                </div>
                                                <div className="flex flex-wrap items-center gap-4 text-sm font-sans mb-4 p-2 rounded-lg bg-[var(--bg-panel)] opacity-80 bg-highlight">
                                                    <div className="flex items-center gap-2"><span className="text-[var(--accent)] font-bold text-accent">IPA</span> <span className="font-mono">/{vocab.ipa}/</span></div>
                                                    <div className="w-1 h-1 rounded-full bg-current opacity-50"></div>
                                                    <div className="flex items-center gap-2"><span className="text-[var(--accent)] font-bold text-accent">Phonics</span> <span className="font-mono tracking-wide">{renderFormattedText(vocab.phonics)}</span></div>
                                                </div>
                                                <div className="grid grid-cols-1 gap-4 mb-4">
                                                    <div className="leading-snug pl-1" style={{ color: 'var(--text-main)' }}><span className="font-bold mr-2 text-sm uppercase">Eng Def:</span>{vocab.englishDef}</div>
                                                    <div className="p-4 rounded-xl border-l-4 bg-highlight" style={{ backgroundColor: 'var(--highlight-bg)', borderColor: 'var(--highlight-border)' }}>
                                                        <div className="font-bold text-xs mb-1 font-sans uppercase tracking-wider flex items-center gap-2 text-[var(--accent)] text-accent"><Icons.Sparkles className="w-3 h-3" /> Instant Understanding (中文秒懂)</div>
                                                        <p className="leading-relaxed text-sm md:text-base font-medium" style={{ color: 'var(--text-main)' }}>{vocab.instantUnd}</p>
                                                    </div>
                                                </div>
                                                <div className="pl-1 mt-2 space-y-3">
                                                    <div className="text-sm opacity-80"><span className="font-bold mr-2">Collocations:</span><span className="italic border-b border-[var(--bg-panel)] pb-0.5">{vocab.collocations}</span></div>
                                                    <div className="space-y-2 mt-2">{vocab.sentences.map((sent, sIdx) => (<div key={sIdx} className="text-sm leading-relaxed flex gap-2 cursor-pointer hover:opacity-80 transition-opacity" onClick={() => speakText(sent.en)} title="Click to listen to sentence" style={{ color: 'var(--text-main)' }}><span className="text-[var(--accent)] font-bold text-xs mt-1 text-accent">0{sIdx + 1}</span><div><div>{renderFormattedText(sent.en)} <Icons.Volume2 className="inline w-3 h-3 opacity-50 ml-1 no-print speaker-icon" /></div><div className="opacity-60 text-xs mt-0.5">{sent.ch}</div></div></div>))}</div>
                                                </div>
                                            </div>
                                        ))}</div>
                                    </section>
                                    {material.grammar && (
                                        <section className="break-before-auto mt-12">
                                            <h2 className="text-2xl font-bold mb-6 flex items-center gap-3 font-sans border-t border-gray-200 pt-8" style={{ color: 'var(--text-main)' }}><span className="text-[#65A30D] text-3xl print:text-black">03.</span> Grammar Focus</h2>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 print:grid-cols-1">{material.grammar.map((item, idx) => (
                                                <div key={idx} className="p-6 rounded-2xl border break-inside-avoid bg-highlight" style={{ backgroundColor: 'var(--highlight-bg)', borderColor: 'var(--bg-panel)' }}>
                                                    <div className="flex items-center gap-2 mb-3"><Icons.Feather className="w-5 h-5 text-[#65A30D] text-accent" /><h3 className="font-bold text-lg text-[#365314] text-accent">{item.point}</h3></div>
                                                    <p className="mb-4 text-sm leading-relaxed min-h-[3em]" style={{ color: 'var(--text-main)' }}>{renderFormattedText(item.explanation)}</p>
                                                    <div className="p-3 rounded-lg border text-sm font-serif italic print:border-gray-200" style={{ backgroundColor: 'var(--bg-paper)', borderColor: 'var(--bg-panel)', color: 'var(--text-muted)' }}>"{renderFormattedText(item.example)}"</div>
                                                </div>
                                            ))}</div>
                                        </section>
                                    )}
                                    <footer className="mt-16 flex justify-between items-center opacity-60 text-[10px] font-sans border-t border-gray-200 pt-6 uppercase tracking-widest"><span>Created for Audiophile & Learner</span><span>{new Date().toLocaleDateString()}</span></footer>
                                </div>
                            </div>
                        )}
                        {!material && !loading && (
                            <div className="text-center py-32 opacity-40 no-print select-none animate-pulse-slow">
                                <div className="w-24 h-24 rounded-full bg-[var(--bg-panel)] shadow-neumorph mx-auto mb-8 flex items-center justify-center text-[var(--accent)]"><Icons.Coffee className="w-10 h-10" /></div>
                                <p className="text-2xl font-bold mb-2">Design Your Learning</p>
                                <p className="text-sm">Select a topic, level, and style to begin</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnglishMaterialGenerator />);
    </script>
</body>
</html>
