<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025äº¬çŸ³å®¶æ—è–èª•äº¤æ›ç¦®ç‰©</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #2C5545; 
            --text-primary: #F3F8F5;
            --text-secondary: #8DAFA3;
            --shadow-light: rgba(255, 255, 255, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.35);
            --xmas-red: #D32F2F;
            --xmas-gold: #FFD700;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(circle at 50% 0%, rgba(255,255,255,0.05) 0%, transparent 70%);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .neu-raised {
            background: var(--bg-color);
            border-radius: 24px;
            box-shadow: 10px 10px 20px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .neu-pressed {
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);
            border: none;
            outline: none;
        }

        .neu-btn {
            border: none;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
            border-radius: 20px;
            background: var(--bg-color);
            box-shadow: 8px 8px 16px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.02);
            letter-spacing: 0.1em; 
        }

        .neu-btn:active:not(:disabled) {
            transform: scale(0.98);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        .neu-btn.selected {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            color: var(--xmas-gold);
            border: 2px solid var(--xmas-gold);
        }

        .btn-fill-red {
            background: linear-gradient(145deg, #E23333, #BE2B2B);
            color: white;
            box-shadow: 6px 6px 12px rgba(0,0,0,0.4), -6px -6px 12px rgba(255,255,255,0.1);
        }

        .slot-active {
            animation: pulse-gold 1.5s infinite;
            border: 3px solid var(--xmas-gold);
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .slot-rolling span {
            filter: blur(3px);
            opacity: 0.7;
            transform: scale(0.9);
        }

        .snowflake { position: absolute; color: white; opacity: 0.3; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }

        /* è²“å’ªæ¨£å¼ */
        .cat-container {
            position: fixed;
            z-index: 40;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .cat-bubble {
            position: absolute;
            background: white;
            color: #333;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .cat-container:hover .cat-bubble { opacity: 1; transform: scale(1); }
        .cat-left { bottom: -25px; left: 20px; width: 180px; }
        .cat-right { bottom: -25px; right: 20px; width: 180px; }
        .cat-top { top: -20px; right: 20px; width: 150px; }

        @media (max-width: 768px) {
            .cat-left, .cat-right { width: 110px; }
            .cat-top { width: 100px; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <div id="snow-container"></div>
    
    <!-- éŸ³æ•ˆé–‹é—œ -->
    <button id="sound-toggle" class="neu-btn fixed top-5 right-5 z-50 w-12 h-12 rounded-full" onclick="toggleSound()">
        <i class="ph-fill ph-speaker-simple-high" id="sound-icon"></i>
    </button>

    <!-- è£é£¾è²“å’ª -->
    <div class="cat-container cat-left" onclick="meow(event)">
        <div class="cat-bubble">èª°æœƒæ˜¯å¹¸é‹å…’ï¼Ÿâœ¨</div>
        <img src="cat.png" onerror="this.src='https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=300&auto=format&fit=crop'" class="w-full">
    </div>
    <div class="cat-container cat-right" onclick="meow(event)">
        <div class="cat-bubble">è–èª•å¿«æ¨‚ï¼å–µï½ ğŸ„</div>
        <img src="cat2.png" onerror="this.src='https://images.unsplash.com/photo-1533738363-b7f9aef128ce?q=80&w=300&auto=format&fit=crop'" class="w-full">
    </div>

    <!-- æ¨™é¡Œ -->
    <header class="text-center mb-8 relative z-10">
        <h1 class="text-4xl md:text-6xl font-black text-[#F3F8F5] mb-2 drop-shadow-xl leading-tight">
            2025äº¬çŸ³å®¶æ—<br><span class="text-[#FFD700]">è–èª•äº¤æ›ç¦®ç‰©å¤§æœƒ</span>
        </h1>
        <div class="h-1 w-20 bg-[#D32F2F] mx-auto rounded-full mt-4"></div>
    </header>

    <!-- 1. è¨­å®šç•«é¢ -->
    <div id="setup-screen" class="w-full max-w-3xl neu-raised p-8 flex flex-col gap-6 animate-fade-in relative z-10 mb-12">
        <div class="flex items-center gap-4 border-b border-white/10 pb-4">
            <i class="ph-duotone ph-list-dashes text-3xl text-[#FFD700]"></i>
            <h2 class="text-xl font-bold text-white tracking-widest">åƒèˆ‡è€…åå–® (å…¬å¹³æŠ½ç±¤ç‰ˆ)</h2>
        </div>

        <textarea id="name-input" 
            class="neu-pressed w-full h-80 p-6 text-xl font-bold resize-none text-white/90"
            placeholder="è¼¸å…¥åƒèˆ‡è€…">è¨±ç¸½
å°éœ
ç“…å„€
é›…èŒ¹
æƒ é›¯
æ´§ç³
è–é›…
åº­ç‘‹
æŸå‹³
æ¦®è€€
èŠ¸è“
ç§€æ…§
ç«¶æ–‡
å£«è±ª
éŸ‹ä¹‹
å®¥å©•
ä¿Šç”·
æ± æ°´
æ¬£è«­
æ­¦ä¿Š
èªå©•
éšå®¹
ç¾å¦‚
å˜‰æœ¨
è© å©·
æ²æ€¡</textarea>

        <button onclick="initGame()" class="neu-btn btn-fill-red w-full py-6 text-xl rounded-3xl gap-3 hover:scale-[1.01] tracking-widest">
            é–‹å§‹æ´¾å°
        </button>
    </div>

    <!-- 2. éŠæˆ²ç•«é¢ -->
    <div id="game-screen" class="w-full max-w-6xl hidden flex-col gap-8 animate-fade-in relative z-10 mb-12">
        <div class="neu-raised p-6 md:p-10">
            <h3 class="text-xl font-bold text-[#F3F8F5] mb-8 flex items-center gap-4">
                <span class="bg-[#D32F2F] text-white w-8 h-8 rounded-full flex items-center justify-center text-base shadow-md font-bold">1</span>
                <span>è«‹é¸æ“‡ä½ çš„åå­—</span>
            </h3>
            <div id="giver-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </div>

        <div id="slot-section" class="neu-raised p-8 md:p-14 text-center hidden opacity-0 transition-opacity duration-500">
            <div id="slot-window" class="w-full h-64 md:h-80 neu-pressed flex items-center justify-center overflow-hidden rounded-[2rem] bg-[#234437]">
                <div id="slot-reel" class="text-6xl md:text-8xl font-black text-[#FFD700] drop-shadow-2xl">?</div>
            </div>
            <button id="spin-btn" onclick="spin()" class="neu-btn btn-fill-red py-6 px-16 text-2xl rounded-full mt-10 w-full md:w-auto tracking-widest">
                æŒ‰æˆ‘æŠ½ç
            </button>
        </div>
    </div>

    <!-- çµæœå½ˆçª— -->
    <div id="result-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="neu-raised bg-[#8B0000] p-10 max-w-2xl w-full text-center border-4 border-[#FFD700]">
            <h2 class="text-2xl font-bold text-[#FFD700] mb-1">æ­å–œä½ æŠ½åˆ°</h2>
            <div class="my-6 py-8 border-y border-[#FFD700]/30">
                <div id="result-name" class="text-6xl md:text-8xl font-black text-white mb-4">Name</div>
                <p class="text-white/90 text-2xl font-bold">çš„ç¦®ç‰© ğŸ</p>
            </div>
            <button onclick="closeResult()" class="neu-btn w-full py-6 text-2xl font-bold bg-[#2E7D32] text-white">ä¸‹ä¸€ä½ï¼</button>
        </div>
    </div>

    <script>
        let participants = [];
        let exchangeMap = {};
        let remainingGivers = [];
        let currentGiver = null;
        let isSpinning = false;
        let historyLog = [];
        let audioCtx = null;
        let isMuted = false;

        // --- éŸ³æ•ˆç³»çµ± ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playNote(freq, duration, type = 'sine', vol = 0.1) {
            if (isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playWinSound() {
            [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                setTimeout(() => playNote(f, 0.8, 'triangle', 0.15), i * 100);
            });
        }

        function toggleSound() {
            isMuted = !isMuted;
            document.getElementById('sound-icon').className = isMuted ? 'ph-fill ph-speaker-simple-slash' : 'ph-fill ph-speaker-simple-high';
            initAudio();
        }

        // --- æ ¸å¿ƒé‚è¼¯ (å…¬å¹³ç‰ˆ) ---
        function generateDerangement(names) {
            let shuffled = [...names];
            let isValid = false;
            let attempts = 0;

            // é€™è£¡ä¸å†æœ‰ä»»ä½• "if (name === 'xxx')" çš„é™åˆ¶
            while (!isValid && attempts < 10000) {
                attempts++;
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                isValid = true;
                for (let i = 0; i < names.length; i++) {
                    // å”¯ä¸€è¦å‰‡ï¼šä¸å¯ä»¥æŠ½åˆ°è‡ªå·±
                    if (names[i] === shuffled[i]) {
                        isValid = false;
                        break;
                    }
                }
            }

            const map = {};
            names.forEach((name, i) => map[name] = shuffled[i]);
            return map;
        }

        function initGame() {
            initAudio();
            const raw = document.getElementById('name-input').value;
            participants = raw.split('\n').map(n => n.trim()).filter(n => n);
            if (participants.length < 2) return alert('è‡³å°‘éœ€è¦å…©å€‹äººï¼');
            
            exchangeMap = generateDerangement(participants);
            remainingGivers = [...participants].sort(() => Math.random() - 0.5);
            
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            renderGiverButtons();
        }

        function renderGiverButtons() {
            const grid = document.getElementById('giver-grid');
            grid.innerHTML = remainingGivers.length ? '' : '<div class="col-span-full text-center py-10 text-2xl font-bold">ğŸ‰ å…¨å“¡äº¤æ›å®Œç•¢ï¼</div>';
            remainingGivers.forEach(name => {
                const btn = document.createElement('button');
                btn.className = 'neu-btn py-6 px-2 text-xl hover:text-[#FFD700]';
                btn.innerText = name;
                btn.onclick = () => selectGiver(name, btn);
                grid.appendChild(btn);
            });
        }

        function selectGiver(name, btnEl) {
            if (isSpinning) return;
            initAudio();
            document.querySelectorAll('#giver-grid button').forEach(b => b.classList.remove('selected'));
            btnEl.classList.add('selected');
            currentGiver = name;
            
            const slot = document.getElementById('slot-section');
            slot.classList.remove('hidden');
            setTimeout(() => slot.classList.remove('opacity-0'), 50);
            document.getElementById('slot-reel').innerText = '?';
        }

        function spin() {
            if (!currentGiver || isSpinning) return;
            isSpinning = true;
            const reel = document.getElementById('slot-reel');
            const pool = participants.filter(p => p !== currentGiver);
            
            let start = null;
            function animate(timestamp) {
                if (!start) start = timestamp;
                if (timestamp - start < 2000) {
                    reel.innerText = pool[Math.floor(Math.random() * pool.length)];
                    playNote(200 + Math.random() * 50, 0.05, 'square', 0.05);
                    requestAnimationFrame(animate);
                } else {
                    finalize();
                }
            }
            requestAnimationFrame(animate);
        }

        function finalize() {
            const target = exchangeMap[currentGiver];
            document.getElementById('slot-reel').innerText = target;
            playWinSound();
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            
            setTimeout(() => {
                document.getElementById('result-name').innerText = target;
                document.getElementById('result-modal').classList.remove('hidden');
                historyLog.push({ giver: currentGiver, receiver: target });
                remainingGivers = remainingGivers.filter(n => n !== currentGiver);
            }, 800);
            isSpinning = false;
        }

        function closeResult() {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('slot-section').classList.add('hidden');
            renderGiverButtons();
        }

        function meow(e) {
            initAudio();
            playNote(800, 0.2, 'sine', 0.1);
            confetti({ particleCount: 20, origin: { x: e.clientX/innerWidth, y: e.clientY/innerHeight } });
        }

        function createSnow() {
            const container = document.getElementById('snow-container');
            for(let i=0; i<20; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.innerText = 'â„';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = Math.random() * 3 + 4 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();
    </script>
</body>
</html>
