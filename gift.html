<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025äº¬çŸ³å®¶æ—è–èª•äº¤æ›ç¦®ç‰©</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons (åœ–ç¤ºåº«) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Canvas Confetti (æ‹‰ç‚®ç‰¹æ•ˆ) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Google Fonts: å¼•å…¥ Noto Sans TC (æ€æºé»‘é«”) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- è®Šæ•¸è¨­å®š --- */
        :root {
            --bg-color: #2C5545; 
            --text-primary: #F3F8F5;
            --text-secondary: #8DAFA3;
            --shadow-light: rgba(255, 255, 255, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.35);
            --xmas-red: #D32F2F;
            --xmas-red-dark: #9A1C1C;
            --xmas-gold: #FFD700;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(circle at 50% 0%, rgba(255,255,255,0.05) 0%, transparent 70%);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- æ“¬æ…‹é¢¨æ ¼ CSS --- */
        .neu-raised {
            background: var(--bg-color);
            border-radius: 24px;
            box-shadow: 10px 10px 20px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .neu-pressed {
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);
            border: none;
            outline: none;
        }

        .neu-btn {
            border: none;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
            border-radius: 20px;
            background: var(--bg-color);
            box-shadow: 8px 8px 16px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.02);
            letter-spacing: 0.1em; 
        }

        .neu-btn:active:not(:disabled) {
            transform: scale(0.98);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        .neu-btn.selected {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            color: var(--xmas-gold);
            border: 2px solid var(--xmas-gold);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .btn-fill-red {
            background: linear-gradient(145deg, #E23333, #BE2B2B);
            color: white;
            box-shadow: 6px 6px 12px rgba(0,0,0,0.4), -6px -6px 12px rgba(255,255,255,0.1);
        }

        .slot-active {
            animation: pulse-gold 1.5s infinite;
            border: 3px solid var(--xmas-gold);
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .slot-rolling span {
            filter: blur(3px);
            opacity: 0.7;
            transform: scale(0.9);
        }
        
        .title-chinese {
            font-weight: 900;
            letter-spacing: 0.15em; 
        }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); }
        
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; color: white; opacity: 0.3; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }

        .text-giant { font-size: 5rem; line-height: 1.2; }
        @media (min-width: 768px) { .text-giant { font-size: 7rem; } }

        /* --- è²“å’ªé€šç”¨æ¨£å¼ --- */
        .cat-container {
            position: fixed;
            z-index: 40;
            height: auto;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        .cat-img {
            width: 100%;
            display: block;
            pointer-events: none;
        }

        /* å°è©±æ¡†æ°£æ³¡ */
        .cat-bubble {
            position: absolute;
            background: white;
            color: #333;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            pointer-events: none;
            white-space: nowrap;
        }
        .cat-container:hover .cat-bubble {
            opacity: 1;
            transform: scale(1);
        }

        /* --- å·¦é‚Šè²“ (cat.png) --- */
        .cat-left { bottom: -25px; left: 20px; width: 180px; }
        .cat-left:hover { transform: translateY(-30px); }
        .cat-left .cat-bubble { top: -50px; left: 10px; }
        .cat-left .cat-bubble::after { content: ''; position: absolute; bottom: -8px; left: 20px; border-width: 8px 8px 0; border-style: solid; border-color: white transparent; }
        .cat-left:hover .cat-bubble { top: -60px; }

        /* --- å³é‚Šè²“ (cat2.png) --- */
        .cat-right { bottom: -25px; right: 20px; width: 180px; }
        .cat-right:hover { transform: translateY(-30px); }
        .cat-right .cat-bubble { top: -50px; right: 10px; }
        .cat-right .cat-bubble::after { content: ''; position: absolute; bottom: -8px; right: 20px; border-width: 8px 8px 0; border-style: solid; border-color: white transparent; }
        .cat-right:hover .cat-bubble { top: -60px; }

        /* --- ä¸Šæ–¹è²“ (cat3.png) --- */
        .cat-top { top: -20px; right: 20px; width: 150px; }
        .cat-top:hover { transform: translateY(30px); }
        .cat-top .cat-bubble { bottom: -50px; right: 40px; }
        .cat-top .cat-bubble::after { content: ''; position: absolute; top: -8px; right: 20px; border-width: 0 8px 8px; border-style: solid; border-color: transparent transparent white; }
        .cat-top:hover .cat-bubble { bottom: -65px; }

        @media (max-width: 768px) {
            .cat-left { width: 110px; left: -10px; bottom: -15px; }
            .cat-right { width: 110px; right: -10px; bottom: -15px; }
            .cat-top { width: 100px; right: 0px; top: -10px; }
        }

        /* éŸ³æ•ˆæŒ‰éˆ• */
        #sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <div id="snow-container"></div>
    
    <!-- éŸ³æ•ˆé–‹é—œ -->
    <button id="sound-toggle" class="neu-btn" onclick="toggleSound()" title="é–‹é—œéŸ³æ•ˆ">
        <i class="ph-fill ph-speaker-simple-high" id="sound-icon"></i>
    </button>

    <!-- 1. å·¦é‚Šè²“ -->
    <div class="cat-container cat-left" onclick="meow(event)">
        <div class="cat-bubble">é¸æˆ‘é¸æˆ‘ï¼âœ¨</div>
        <img src="cat.png" onerror="this.src='https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=300&auto=format&fit=crop'" alt="Left Cat" class="cat-img">
    </div>

    <!-- 2. å³é‚Šè²“ -->
    <div class="cat-container cat-right" onclick="meow(event)">
        <div class="cat-bubble">è–èª•å¿«æ¨‚ï¼å–µï½ ğŸ„</div>
        <img src="cat2.png" onerror="this.src='https://images.unsplash.com/photo-1533738363-b7f9aef128ce?q=80&w=300&auto=format&fit=crop'" alt="Right Cat" class="cat-img">
    </div>

    <!-- 3. ä¸Šæ–¹è²“ -->
    <div class="cat-container cat-top" onclick="meow(event)">
        <div class="cat-bubble">è¨±ç¸½å†åŠ ç¢¼ï¼ï¼ğŸ‘€</div>
        <img src="cat3.png" onerror="this.src='https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?q=80&w=300&auto=format&fit=crop'" alt="Top Cat" class="cat-img">
    </div>

    <!-- æ¨™é¡Œ -->
    <header class="text-center mb-8 relative z-10 mt-6 md:mt-0">
        <h1 class="text-4xl md:text-6xl font-black text-[#F3F8F5] mb-2 title-chinese drop-shadow-xl leading-tight">
            2025äº¬çŸ³å®¶æ—<br><span class="text-[#FFD700]">è–èª•äº¤æ›ç¦®ç‰©å¤§æœƒ</span>
        </h1>
        <div class="h-1 w-20 bg-[#D32F2F] mx-auto rounded-full mt-4"></div>
    </header>

    <!-- 1. è¨­å®šç•«é¢ -->
    <div id="setup-screen" class="w-full max-w-3xl neu-raised p-8 flex flex-col gap-6 animate-fade-in relative z-10 mb-12">
        <div class="flex items-center gap-4 border-b border-white/10 pb-4">
            <i class="ph-duotone ph-list-dashes text-3xl text-[#FFD700]"></i>
            <div>
                <h2 class="text-xl font-bold text-white tracking-widest">åƒèˆ‡è€…åå–®</h2>
                <p class="text-sm text-[#8DAFA3] font-medium">è«‹ç¢ºèªæ‰€æœ‰åƒåŠ çš„äººå“¡</p>
            </div>
        </div>

        <textarea id="name-input" 
            class="neu-pressed w-full h-80 p-6 text-xl md:text-2xl font-bold resize-none focus:border focus:border-white/20 transition-colors leading-relaxed tracking-wide text-white/90"
            placeholder="è¼¸å…¥åƒèˆ‡è€…">è¨±ç¸½
å°éœ
ç“…å„€
é›…èŒ¹
æƒ é›¯
æ´§ç³
è–é›…
åº­ç‘‹
æŸå‹³
æ¦®è€€
èŠ¸è“
ç§€æ…§
ç«¶æ–‡
å£«è±ª
éŸ‹ä¹‹
å®¥å©•
ä¿Šç”·
æ± æ°´
æ¬£è«­
æ­¦ä¿Š
èªå©•
éšå®¹
ç¾å¦‚
å˜‰æœ¨
è© å©·
æ²æ€¡</textarea>

        <button onclick="initGame()" class="neu-btn btn-fill-red w-full py-6 text-xl md:text-2xl rounded-3xl gap-3 mt-2 hover:scale-[1.01] tracking-widest">
            é–‹å§‹æ´¾å°
        </button>
    </div>

    <!-- 2. éŠæˆ²ç•«é¢ -->
    <div id="game-screen" class="w-full max-w-6xl hidden flex-col gap-8 animate-fade-in relative z-10 mb-12">
        
        <!-- ä¸Šæ–¹ï¼šæˆ‘æ˜¯èª° -->
        <div class="neu-raised p-6 md:p-10">
            <h3 class="text-xl md:text-2xl font-bold text-[#F3F8F5] mb-8 flex items-center gap-4">
                <span class="bg-[#D32F2F] text-white w-8 h-8 rounded-full flex items-center justify-center text-base shadow-md font-bold">1</span>
                <span class="tracking-widest">ä½ æ˜¯èª°ï¼Ÿ</span> 
                <span class="text-base md:text-lg font-normal text-[#8DAFA3] ml-auto">è«‹é»æ“Šåå­—</span>
            </h3>
            
            <div id="giver-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                <!-- æŒ‰éˆ•ç”Ÿæˆå€ -->
            </div>
        </div>

        <!-- ä¸‹æ–¹ï¼šæ‹‰éœ¸å€ -->
        <div id="slot-section" class="neu-raised p-8 md:p-14 text-center relative hidden opacity-0 transition-opacity duration-500">
            <div class="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-[#D32F2F] text-white px-8 py-2 rounded-full shadow-xl font-bold flex items-center gap-3 border-2 border-[#FFD700] whitespace-nowrap z-20">
                <span id="current-player-name" class="text-lg tracking-widest"></span> 
            </div>

            <div class="mt-8 mb-10">
                <!-- æ‹‰éœ¸è¦–çª— -->
                <div class="w-full h-64 md:h-80 neu-pressed flex items-center justify-center overflow-hidden relative rounded-[2rem] border-4 border-transparent transition-all duration-300 bg-[#234437]" id="slot-window">
                    <div id="slot-reel" class="text-giant font-black text-[#FFD700] tracking-tight drop-shadow-2xl">
                        ?
                    </div>
                </div>
            </div>

            <button id="spin-btn" onclick="spin()" class="neu-btn btn-fill-red py-6 px-16 text-2xl md:text-3xl rounded-full shadow-2xl transform active:scale-95 transition-all w-full md:w-auto min-w-[300px] border-4 border-[#B71C1C] tracking-widest">
                æŒ‰æˆ‘æŠ½ç
            </button>
        </div>

        <div class="flex justify-center gap-6 mt-4 opacity-60 hover:opacity-100 transition-opacity">
            <button onclick="showHistory()" class="neu-btn px-8 py-4 text-base tracking-widest text-[#8DAFA3]">
                æŸ¥çœ‹ç´€éŒ„
            </button>
            <button onclick="resetGame()" class="neu-btn px-8 py-4 text-base tracking-widest text-[#E57373]">
                é‡æ–°é–‹å§‹
            </button>
        </div>
    </div>

    <!-- çµæœå½ˆçª— -->
    <div id="result-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4">
        <div class="neu-raised bg-[#8B0000] p-8 md:p-12 max-w-2xl w-full text-center relative animate-[popIn_0.4s_ease-out] border-4 border-[#FFD700]">
            
            <!-- è£é£¾æ¨™é¡Œ -->
            <div class="mb-2">
                <i class="ph-fill ph-confetti text-4xl text-[#FFD700] mb-2 inline-block"></i>
            </div>

            <h2 class="text-2xl md:text-3xl font-bold text-[#FFD700] tracking-widest mb-1">æ­å–œä½ æŠ½åˆ°</h2>
            
            <div class="my-6 py-8 border-t border-b border-[#FFD700]/30 flex flex-col items-center">
                <!-- çµæœåå­— -->
                <div id="result-name" class="text-6xl md:text-8xl font-black text-white break-words leading-tight drop-shadow-xl tracking-wide mb-4">
                    Name
                </div>
                <!-- çµå°¾è© -->
                <p class="text-white/90 text-2xl md:text-3xl tracking-widest font-bold">
                    çš„ç¦®ç‰© ğŸ
                </p>
            </div>

            <button onclick="closeResult()" class="neu-btn w-full py-6 text-2xl font-bold bg-[#2E7D32] text-white hover:bg-[#256328] shadow-xl border-none tracking-widest">
                ä¾†ï¼ä¸‹é¢ä¸€ä½ï¼
            </button>
        </div>
    </div>

    <script>
        let participants = [];
        let exchangeMap = {};
        let remainingGivers = [];
        let currentGiver = null;
        let isSpinning = false;
        let historyLog = [];
        
        /* --- éŸ³æ•ˆç³»çµ± (ä½¿ç”¨ Web Audio API åˆæˆè²éŸ³ï¼Œç„¡éœ€å¤–éƒ¨æª”æ¡ˆ) --- */
        let audioCtx = null;
        let isMuted = false;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function toggleSound() {
            isMuted = !isMuted;
            const icon = document.getElementById('sound-icon');
            if (isMuted) {
                icon.classList.remove('ph-speaker-simple-high');
                icon.classList.add('ph-speaker-simple-slash');
            } else {
                icon.classList.remove('ph-speaker-simple-slash');
                icon.classList.add('ph-speaker-simple-high');
                // æ’­æ”¾ä¸€å€‹æ¸¬è©¦éŸ³æ•ˆç¢ºèªé–‹å•Ÿ
                playNote(600, 0.1, 'sine');
            }
            initAudio(); // ç¢ºä¿ä½¿ç”¨è€…äº’å‹•å¾Œ AudioContext å•Ÿå‹•
        }

        // åŸºç¤éŸ³èª¿ç”¢ç”Ÿå™¨
        function playNote(freq, duration, type = 'sine', vol = 0.1) {
            if (isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // 1. è½‰å‹•æ™‚çš„æ©Ÿæ¢°è² (çŸ­ä¿ƒçš„æ–¹æ³¢)
        function playTickSound() {
            playNote(200 + Math.random() * 50, 0.05, 'square', 0.05); 
        }

        // 2. ä¸­çéŸ³æ•ˆ (å¤§ä¸‰å’Œå¼¦ç¶éŸ³)
        function playWinSound() {
            if (isMuted || !audioCtx) return;
            const now = audioCtx.currentTime;
            // C Major ç¶éŸ³: C5, E5, G5, C6
            const notes = [523.25, 659.25, 783.99, 1046.50];
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = freq;
                
                // æ™‚é–“å·®æ’­æ”¾
                const startTime = now + i * 0.1;
                const duration = 0.8;
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.15, startTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(startTime);
                osc.stop(startTime + duration);
            });
        }

        // 3. è²“å«è² (æ¨¡æ“¬)
        function playMeow() {
            if (isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine'; // è²“å«é€šå¸¸æ¥è¿‘æ­£å¼¦æ³¢
            
            // é »ç‡è®ŠåŒ–ï¼šå¾ä¸­éŸ³æ»‘åˆ°é«˜éŸ³å†æ»‘ä¸‹ä¾† (Me-ow)
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.15); // Me...
            osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.4);  // ...ow
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.1);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        /* --- éŠæˆ²é‚è¼¯ --- */

        // è²“å’ªé»æ“Šäº’å‹•
        function meow(event) {
            initAudio(); // ç¢ºä¿è²éŸ³å•Ÿå‹•
            playMeow();  // æ’­æ”¾è²“å«
            
            const x = event.clientX / window.innerWidth;
            const y = event.clientY / window.innerHeight;

            confetti({
                particleCount: 30,
                spread: 60,
                origin: { x: x, y: y }, 
                colors: ['#FF69B4', '#FFD700', '#FFFFFF'],
                shapes: ['circle'], 
                scalar: 1.2,
                drift: 0,
                gravity: 0.8
            });
        }

        function createSnow() {
            const container = document.getElementById('snow-container');
            for(let i=0; i<30; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.innerHTML = 'â„';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = Math.random() * 3 + 5 + 's';
                flake.style.opacity = Math.random() * 0.5;
                flake.style.fontSize = Math.random() * 15 + 15 + 'px'; 
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateDerangement(names) {
            let shuffled = [...names];
            let isValid = false;
            let attempts = 0;

            while (!isValid && attempts < 50000) {
                attempts++;
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                isValid = true;
                for (let i = 0; i < names.length; i++) {
                    const giver = names[i];
                    const receiver = shuffled[i];
                    if (giver === receiver) { isValid = false; break; }
                    // 1. è–é›…æŒ‡å®šæ¢ä»¶
                    if (giver === "è–é›…" && receiver !== "æƒ é›¯") { isValid = false; break; }
                    // 2. æƒ é›¯æ’é™¤æ¢ä»¶
                    if (giver === "æƒ é›¯" && (receiver === "èªå©•" || receiver === "ç¾å¦‚" || receiver === "å˜‰æœ¨" || receiver === "æ¦®è€€")) { isValid = false; break; }
                }
            }

            if (!isValid) {
                alert("ç³»çµ±åˆ†é…å¤±æ•—(æ¢ä»¶éæ–¼åš´è‹›)ï¼Œè«‹é‡æ–°æ•´ç†å†è©¦ä¸€æ¬¡ã€‚");
                return {};
            }
            const map = {};
            names.forEach((name, i) => map[name] = shuffled[i]);
            return map;
        }

        function initGame() {
            initAudio(); // ç”¨æˆ¶äº’å‹•æ™‚åˆå§‹åŒ– AudioContext
            const raw = document.getElementById('name-input').value;
            participants = raw.split('\n').map(n => n.trim()).filter(n => n);
            if (participants.length < 2) {
                alert('è‡³å°‘éœ€è¦å…©å€‹äººæ‰èƒ½äº¤æ›ç¦®ç‰©å–”ï¼');
                return;
            }
            exchangeMap = generateDerangement(participants);
            remainingGivers = shuffleArray([...participants]);
            document.getElementById('setup-screen').classList.add('hidden');
            const gameScreen = document.getElementById('game-screen');
            gameScreen.classList.remove('hidden');
            gameScreen.classList.add('flex');
            renderGiverButtons();
        }

        function renderGiverButtons() {
            const grid = document.getElementById('giver-grid');
            grid.innerHTML = '';
            if (remainingGivers.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-white/50 py-10 text-3xl font-bold">ğŸ‰ æ´¾å°åœ“æ»¿çµæŸï¼</div>';
                return;
            }
            remainingGivers.forEach(name => {
                const btn = document.createElement('button');
                btn.className = 'neu-btn py-6 px-2 text-2xl md:text-3xl hover:text-[#FFD700] hover:border-[#FFD700] w-full min-h-[100px] break-words transition-colors';
                btn.innerHTML = name;
                btn.onclick = () => selectGiver(name, btn);
                grid.appendChild(btn);
            });
        }

        function selectGiver(name, btnEl) {
            if (isSpinning) return;
            initAudio(); // ç¢ºä¿è²éŸ³æº–å‚™å¥½
            
            // æ’­æ”¾é¸æ“‡éŸ³æ•ˆ (çŸ­ä¿ƒçš„é«˜éŸ³)
            playNote(800, 0.05, 'sine', 0.05);

            document.querySelectorAll('#giver-grid button').forEach(b => b.classList.remove('selected'));
            btnEl.classList.add('selected');
            currentGiver = name;
            
            const slotSection = document.getElementById('slot-section');
            slotSection.classList.remove('hidden');
            setTimeout(() => {
                slotSection.classList.remove('opacity-0');
                slotSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);

            document.getElementById('current-player-name').textContent = name;
            document.getElementById('slot-reel').innerHTML = '<span class="text-7xl font-bold">?</span>';
            document.getElementById('slot-window').classList.remove('slot-active');
            
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = false;
            spinBtn.innerHTML = 'æŒ‰æˆ‘æŠ½ç';
            spinBtn.classList.add('btn-fill-red');
            spinBtn.classList.remove('bg-black/20', 'text-gray-400', 'shadow-none', 'border-transparent');
        }

        function spin() {
            if (!currentGiver || isSpinning) return;
            initAudio();

            isSpinning = true;
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = true;
            spinBtn.classList.remove('btn-fill-red');
            spinBtn.classList.add('bg-black/20', 'text-gray-400', 'shadow-none', 'border-transparent');
            spinBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';

            const slotWindow = document.getElementById('slot-window');
            slotWindow.classList.add('slot-active');

            const reel = document.getElementById('slot-reel');
            reel.classList.add('slot-rolling');

            const pool = participants.filter(p => p !== currentGiver);
            let duration = 2500;
            let start = null;
            let lastTickTime = 0;

            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;

                if (progress < duration) {
                    const randomName = pool[Math.floor(Math.random() * pool.length)];
                    reel.innerText = randomName;

                    // æ¯ 100ms æ’­æ”¾ä¸€æ¬¡ã€Œç­”ã€çš„è²éŸ³ï¼Œæ¨¡æ“¬è½‰å‹•è²
                    if (timestamp - lastTickTime > 80) {
                        playTickSound();
                        lastTickTime = timestamp;
                    }

                    requestAnimationFrame(animate);
                } else {
                    finalize();
                }
            }
            requestAnimationFrame(animate);
        }

        function finalize() {
            const target = exchangeMap[currentGiver];
            const reel = document.getElementById('slot-reel');
            
            reel.innerText = target;
            reel.classList.remove('slot-rolling');
            document.getElementById('slot-window').classList.remove('slot-active');

            // æ’­æ”¾ä¸­çéŸ³æ•ˆ
            playWinSound();

            // æ…¶ç¥ç‰¹æ•ˆ
            confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#FFD700', '#D32F2F', '#ffffff'] 
            });

            setTimeout(() => {
                showModal(target);
                historyLog.push({ giver: currentGiver, receiver: target });
                remainingGivers = remainingGivers.filter(n => n !== currentGiver);
            }, 800);

            isSpinning = false;
        }

        function showModal(name) {
            document.getElementById('result-name').innerText = name;
            const modal = document.getElementById('result-modal');
            modal.classList.remove('hidden');
        }

        function closeResult() {
            // é—œé–‰æ™‚çš„éŸ³æ•ˆ
            playNote(400, 0.1, 'sine', 0.05);

            document.getElementById('result-modal').classList.add('hidden');
            
            const slotSection = document.getElementById('slot-section');
            slotSection.classList.add('opacity-0');
            setTimeout(() => slotSection.classList.add('hidden'), 500);
            
            currentGiver = null;
            renderGiverButtons();

            if (remainingGivers.length === 0) {
                setTimeout(() => {
                    confetti({ particleCount: 500, spread: 360, startVelocity: 60 });
                    alert("ğŸ„ è–èª•å¿«æ¨‚ï¼æ‰€æœ‰äººéƒ½äº¤æ›å®Œç•¢å›‰ï¼");
                }, 500);
            }
        }

        function showHistory() {
            if (historyLog.length === 0) return alert("ç›®å‰æ²’æœ‰ç´€éŒ„");
            let msg = "ğŸ“œ äº¤æ›ç´€éŒ„ï¼š\n";
            historyLog.forEach(log => {
                msg += `${log.giver} -> ${log.receiver}\n`;
            });
            alert(msg);
        }

        function resetGame() {
            if(confirm("ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿ")) {
                location.reload();
            }
        }
    </script>
</body>
</html>
